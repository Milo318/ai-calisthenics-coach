<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CALI">
    <meta name="theme-color" content="#00ff88">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='115' fill='%230a0a0a'/%3E%3Ctext x='50%25' y='55%25' dominant-baseline='middle' text-anchor='middle' font-family='monospace' font-size='180' font-weight='bold' fill='%2300ff88'%3ECALI%3C/text%3E%3C/svg%3E">
    
    <title>CALI ‚Ä¢ AI Coach</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0a0a;
            --surface: #1a1a1a;
            --surface-hover: #252525;
            --text: #ffffff;
            --text-secondary: #a0a0a0;
            --accent: #00ff88;
            --accent-dim: #00ff8820;
            --red: #ff4444;
            --yellow: #ffaa00;
            --blue: #4499ff;
            --radius: 16px;
            --shadow: 0 8px 32px rgba(0, 255, 136, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        .mono {
            font-family: 'Space Mono', monospace;
        }

        .container {
            max-width: 100%;
            padding: 0;
        }

        /* Header */
        header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--bg);
            border-bottom: 2px solid var(--accent);
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .logo {
            font-size: 24px;
            font-weight: 800;
            letter-spacing: 4px;
            color: var(--accent);
            text-transform: uppercase;
        }

        .tagline {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
            letter-spacing: 2px;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 0;
            padding: 20px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab-nav::-webkit-scrollbar {
            display: none;
        }

        .tab-btn {
            flex: 1;
            min-width: 80px;
            padding: 12px 16px;
            background: var(--surface);
            border: 2px solid transparent;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .tab-btn:first-child {
            border-radius: var(--radius) 0 0 var(--radius);
        }

        .tab-btn:last-child {
            border-radius: 0 var(--radius) var(--radius) 0;
        }

        .tab-btn.active {
            background: var(--accent-dim);
            border-color: var(--accent);
            color: var(--accent);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .section {
            padding: 20px;
        }

        .card {
            background: var(--surface);
            border: 2px solid var(--surface);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .card:hover {
            border-color: var(--accent);
            box-shadow: var(--shadow);
        }

        .card-title {
            font-size: 18px;
            font-weight: 800;
            margin-bottom: 16px;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--accent);
        }

        /* Exercise Cards */
        .exercise-grid {
            display: grid;
            gap: 16px;
        }

        .exercise-card {
            background: var(--surface);
            border: 2px solid var(--surface);
            border-radius: var(--radius);
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .exercise-card:active {
            transform: scale(0.98);
        }

        .exercise-card:hover {
            border-color: var(--accent);
            background: var(--surface-hover);
        }

        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .exercise-name {
            font-size: 16px;
            font-weight: 700;
            line-height: 1.3;
        }

        .exercise-level {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .level-beginner {
            background: var(--accent-dim);
            color: var(--accent);
            border: 1px solid var(--accent);
        }

        .level-intermediate {
            background: rgba(255, 170, 0, 0.2);
            color: var(--yellow);
            border: 1px solid var(--yellow);
        }

        .level-advanced {
            background: rgba(255, 68, 68, 0.2);
            color: var(--red);
            border: 1px solid var(--red);
        }

        .exercise-meta {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        /* Workout Builder */
        .workout-slot {
            background: var(--surface);
            border: 2px dashed var(--surface-hover);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 60px;
        }

        .workout-slot.filled {
            border: 2px solid var(--accent);
            background: var(--accent-dim);
        }

        .remove-btn {
            background: var(--red);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 12px;
            text-transform: uppercase;
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 16px;
            background: var(--accent);
            color: var(--bg);
            border: none;
            border-radius: var(--radius);
            font-weight: 800;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 12px;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: var(--surface);
            color: var(--text);
            border: 2px solid var(--accent);
        }

        /* Chat */
        .chat-container {
            height: 400px;
            overflow-y: auto;
            padding: 16px;
            background: var(--bg);
            border-radius: var(--radius);
            margin-bottom: 16px;
        }

        .message {
            margin-bottom: 16px;
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 85%;
            line-height: 1.5;
            font-size: 14px;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-message {
            background: var(--accent);
            color: var(--bg);
            margin-left: auto;
            font-weight: 600;
        }

        .ai-message {
            background: var(--surface);
            border: 2px solid var(--surface-hover);
        }

        .chat-input-container {
            display: flex;
            gap: 12px;
        }

        .chat-input {
            flex: 1;
            padding: 16px;
            background: var(--surface);
            border: 2px solid var(--surface);
            border-radius: var(--radius);
            color: var(--text);
            font-size: 14px;
            font-family: inherit;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .send-btn {
            padding: 16px 24px;
            background: var(--accent);
            color: var(--bg);
            border: none;
            border-radius: var(--radius);
            font-weight: 800;
            cursor: pointer;
            font-size: 14px;
        }

        .send-btn:disabled {
            opacity: 0.5;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .stat-card {
            background: var(--surface);
            border: 2px solid var(--accent);
            border-radius: var(--radius);
            padding: 20px;
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: 800;
            color: var(--accent);
            font-family: 'Space Mono', monospace;
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 8px;
        }

        /* Timer */
        .timer-display {
            font-size: 48px;
            font-weight: 800;
            color: var(--accent);
            text-align: center;
            font-family: 'Space Mono', monospace;
            margin: 24px 0;
            letter-spacing: 4px;
        }

        .timer-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .timer-btn {
            padding: 12px;
            border: none;
            border-radius: var(--radius);
            font-weight: 700;
            cursor: pointer;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .start-btn {
            background: var(--accent);
            color: var(--bg);
        }

        .pause-btn {
            background: var(--yellow);
            color: var(--bg);
        }

        .reset-btn {
            background: var(--red);
            color: white;
        }

        /* Macro Tracker */
        .macro-input {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .macro-field {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .macro-field label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
        }

        .macro-field input {
            padding: 12px;
            background: var(--surface);
            border: 2px solid var(--surface);
            border-radius: var(--radius);
            color: var(--text);
            font-size: 16px;
            font-family: 'Space Mono', monospace;
            font-weight: 700;
        }

        .macro-field input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .macro-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .food-status {
            margin-top: 12px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .barcode-panel {
            margin-top: 16px;
        }

        .barcode-video {
            width: 100%;
            border-radius: var(--radius);
            border: 2px solid var(--surface);
            background: #000;
            margin-top: 12px;
            display: none;
        }

        .barcode-video.active {
            display: block;
        }

        .macro-card {
            background: var(--surface);
            border: 2px solid var(--surface);
            border-radius: var(--radius);
            padding: 16px;
            text-align: center;
        }

        .macro-value {
            font-size: 24px;
            font-weight: 800;
            color: var(--accent);
            font-family: 'Space Mono', monospace;
        }

        .macro-label {
            font-size: 10px;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-top: 4px;
            letter-spacing: 1px;
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--surface);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Setup Screen */
        .setup-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 40px 20px;
        }

        .setup-content {
            max-width: 500px;
            margin: 0 auto;
        }

        .setup-title {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 12px;
            letter-spacing: 2px;
            color: var(--accent);
        }

        .setup-subtitle {
            color: var(--text-secondary);
            margin-bottom: 32px;
            font-size: 14px;
        }

        .setup-input {
            width: 100%;
            padding: 16px;
            background: var(--surface);
            border: 2px solid var(--surface);
            border-radius: var(--radius);
            color: var(--text);
            font-size: 14px;
            margin-bottom: 16px;
            font-family: 'Space Mono', monospace;
        }

        .setup-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .info-box {
            background: var(--surface);
            border-left: 4px solid var(--accent);
            padding: 16px;
            border-radius: var(--radius);
            margin: 16px 0;
            font-size: 13px;
            line-height: 1.6;
        }

        .hidden {
            display: none !important;
        }

        /* Profile */
        .profile-grid {
            display: grid;
            gap: 16px;
        }

        .profile-field {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .profile-field label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
        }

        .profile-field select,
        .profile-field input {
            padding: 12px;
            background: var(--surface);
            border: 2px solid var(--surface);
            border-radius: var(--radius);
            color: var(--text);
            font-size: 14px;
            font-family: inherit;
        }

        .profile-field select:focus,
        .profile-field input:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Responsive */
        @media (min-width: 768px) {
            .container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 0 40px;
            }

            .exercise-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .macro-input {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Setup Screen -->
    <div id="setupScreen" class="setup-screen">
        <div class="setup-content">
            <div class="logo">CALI</div>
            <h1 class="setup-title">AI COACH</h1>
            <p class="setup-subtitle">Powered by Groq + Llama 3 70B</p>

            <div class="card">
                <div class="card-title">‚ö° SETUP</div>
                <input 
                    type="password" 
                    class="setup-input" 
                    id="apiKeyInput" 
                    placeholder="Groq API Key (gsk_...)"
                >
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="btn" onclick="saveApiKey()">START</button>
                    <button class="btn btn-secondary" onclick="clearApiKey()">KEY ZUR√úCKSETZEN</button>
                </div>
                <div class="food-status mono" id="setupStatus"></div>

                <div class="info-box">
                    <strong>Get your free API key:</strong><br>
                    1. Go to <a href="https://console.groq.com/keys" target="_blank" style="color: var(--accent)">console.groq.com/keys</a><br>
                    2. Sign in with Google/GitHub<br>
                    3. Create API Key<br>
                    4. Paste it above
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <header>
            <div class="logo mono">CALI</div>
            <div class="tagline mono">AI COACH</div>
        </header>

        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('chat')">COACH</button>
            <button class="tab-btn" onclick="switchTab('workout')">WORKOUT</button>
            <button class="tab-btn" onclick="switchTab('exercises')">MOVES</button>
            <button class="tab-btn" onclick="switchTab('macros')">MACROS</button>
            <button class="tab-btn" onclick="switchTab('profile')">STATS</button>
        </div>

        <!-- Chat Tab -->
        <div id="tab-chat" class="tab-content active">
            <div class="section">
                <div class="card">
                    <div class="card-title">üí¨ COACH CHAT</div>
                    <div class="chat-container" id="chatContainer"></div>
                    <div class="chat-input-container">
                        <input 
                            type="text" 
                            class="chat-input" 
                            id="chatInput" 
                            placeholder="Ask your coach..."
                            onkeypress="handleKeyPress(event)"
                        >
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()">‚Üí</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Workout Tab -->
        <div id="tab-workout" class="tab-content">
            <div class="section">
                <div class="card">
                    <div class="card-title">üéØ YOUR WORKOUT</div>
                    <div id="workoutBuilder"></div>
                    <button class="btn" onclick="startWorkout()">START WORKOUT</button>
                    <button class="btn btn-secondary" onclick="clearWorkout()">CLEAR</button>
                </div>

                <div class="card">
                    <div class="card-title">‚è±Ô∏è TIMER</div>
                    <div class="timer-display mono" id="timerDisplay">00:00</div>
                    <div class="timer-controls">
                        <button class="timer-btn start-btn" onclick="startTimer()">START</button>
                        <button class="timer-btn pause-btn" onclick="pauseTimer()">PAUSE</button>
                        <button class="timer-btn reset-btn" onclick="resetTimer()">RESET</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Exercises Tab -->
        <div id="tab-exercises" class="tab-content">
            <div class="section">
                <div class="card">
                    <div class="card-title">üìã EXERCISES</div>
                    <div class="exercise-grid" id="exerciseList"></div>
                </div>
            </div>
        </div>

        <!-- Macros Tab -->
        <div id="tab-macros" class="tab-content">
            <div class="section">
                <div class="card">
                    <div class="card-title">üçΩÔ∏è MACRO TRACKER</div>
                    
                    <div class="macro-input">
                        <div class="macro-field">
                            <label>Protein (g)</label>
                            <input type="number" id="proteinInput" value="0" onchange="updateMacros()">
                        </div>
                        <div class="macro-field">
                            <label>Carbs (g)</label>
                            <input type="number" id="carbsInput" value="0" onchange="updateMacros()">
                        </div>
                        <div class="macro-field">
                            <label>Fats (g)</label>
                            <input type="number" id="fatsInput" value="0" onchange="updateMacros()">
                        </div>
                        <div class="macro-field">
                            <label>Calories</label>
                            <input type="number" id="caloriesInput" value="0" readonly>
                        </div>
                    </div>

                    <button class="btn" onclick="logMacros()">LOG TODAY</button>

                    <div class="card-title" style="margin-top: 24px;">ü•ó LEBENSMITTEL-SUCHE</div>
                    <div class="macro-input">
                        <div class="macro-field">
                            <label>Lebensmittel</label>
                            <input type="text" id="foodInput" placeholder="z. B. Banane, Griechischer Joghurt">
                        </div>
                        <div class="macro-field">
                            <label>Menge (g)</label>
                            <input type="number" id="foodAmountInput" value="100">
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="addFoodFromLookup()">LEBENSMITTEL HINZUF√úGEN</button>
                    <div class="food-status mono" id="foodStatus"></div>
                    <div class="barcode-panel">
                        <div class="card-title" style="margin-top: 16px;">üì∑ BARCODE SCAN</div>
                        <div class="macro-input">
                            <div class="macro-field">
                                <label>Barcode</label>
                                <input type="text" id="barcodeInput" placeholder="Scanne oder tippe den Barcode">
                            </div>
                            <div class="macro-field">
                                <label>Aktion</label>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-secondary" type="button" onclick="startBarcodeScanner()">SCAN</button>
                                    <button class="btn btn-secondary" type="button" onclick="stopBarcodeScanner()">STOP</button>
                                </div>
                            </div>
                        </div>
                        <button class="btn" type="button" onclick="lookupFoodByBarcode()">BARCODE SUCHEN</button>
                        <video id="barcodeVideo" class="barcode-video" autoplay muted playsinline></video>
                        <div class="food-status mono" id="barcodeStatus"></div>
                    </div>

                    <div class="macro-summary">
                        <div class="macro-card">
                            <div class="macro-value mono" id="totalProtein">0g</div>
                            <div class="macro-label">Protein Today</div>
                        </div>
                        <div class="macro-card">
                            <div class="macro-value mono" id="totalCarbs">0g</div>
                            <div class="macro-label">Carbs Today</div>
                        </div>
                        <div class="macro-card">
                            <div class="macro-value mono" id="totalCals">0</div>
                            <div class="macro-label">Calories</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile/Stats Tab -->
        <div id="tab-profile" class="tab-content">
            <div class="section">
                <div class="card">
                    <div class="card-title">üë§ PROFILE</div>
                    <div class="profile-grid">
                        <div class="profile-field">
                            <label>Level</label>
                            <select id="userLevel" onchange="saveProfile()">
                                <option value="beginner">Beginner</option>
                                <option value="intermediate">Intermediate</option>
                                <option value="advanced">Advanced</option>
                            </select>
                        </div>
                        <div class="profile-field">
                            <label>Goal</label>
                            <select id="userGoal" onchange="saveProfile()">
                                <option value="strength">Build Strength</option>
                                <option value="muscle">Build Muscle</option>
                                <option value="endurance">Endurance</option>
                                <option value="skills">Learn Skills</option>
                            </select>
                        </div>
                        <div class="profile-field">
                            <label>Training Days/Week</label>
                            <input type="number" id="trainingDays" min="1" max="7" value="3" onchange="saveProfile()">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">üìä STATS</div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number mono" id="totalWorkouts">0</div>
                            <div class="stat-label">Workouts</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number mono" id="totalExercises">0</div>
                            <div class="stat-label">Exercises</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number mono" id="streak">0</div>
                            <div class="stat-label">Day Streak</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let exercises = [
            { name: 'Push-ups', level: 'beginner', desc: 'Chest, triceps, shoulders', sets: '3x12', gif: 'https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExZmlybG9rZGFueGQ5NnRjeHM5N3MyOGFvbnB6d3N3dGJpcGt5dmpuZyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/3o7aCTPPm4OHfRLSH6/giphy.gif' },
            { name: 'Pull-ups', level: 'intermediate', desc: 'Back, biceps', sets: '3x8', gif: 'https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExNGo1c3JxZmw3bGJ5bGJ6cjhvbWRwOHJ2dGJpbzZvZmZ0eGNhbTY5ZCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/xT8qBsOjMOcdeGJIU8/giphy.gif' },
            { name: 'Dips', level: 'intermediate', desc: 'Triceps, chest', sets: '3x10', gif: '' },
            { name: 'Squats', level: 'beginner', desc: 'Legs, glutes', sets: '3x15', gif: '' },
            { name: 'Plank', level: 'beginner', desc: 'Core stability', sets: '3x60s', gif: '' },
            { name: 'Muscle-up', level: 'advanced', desc: 'Full body power', sets: '3x5', gif: '' },
            { name: 'Handstand Push-up', level: 'advanced', desc: 'Shoulders, core', sets: '3x6', gif: '' },
            { name: 'L-Sit', level: 'intermediate', desc: 'Core, hip flexors', sets: '3x30s', gif: '' },
            { name: 'Australian Pull-ups', level: 'beginner', desc: 'Back, arms', sets: '3x12', gif: '' },
            { name: 'Front Lever', level: 'advanced', desc: 'Back, core', sets: '3x20s', gif: '' },
            { name: 'Pistol Squats', level: 'advanced', desc: 'Single leg strength', sets: '3x8', gif: '' },
            { name: 'Pike Push-ups', level: 'intermediate', desc: 'Shoulder prep', sets: '3x10', gif: '' }
        ];

        let currentWorkout = [];
        let chatHistory = [];
        let conversationMemory = [];
        let userProfile = { level: 'beginner', goal: 'strength', trainingDays: 3 };
        let stats = { totalWorkouts: 0, totalExercises: 0, streak: 0 };
        let macros = { protein: 0, carbs: 0, fats: 0 };
        let timerInterval = null;
        let timerSeconds = 0;
        let isTimerRunning = false;
        let apiKey = '';
        const foodDatabase = [
            { name: 'Banane', protein: 1.1, carbs: 22.8, fats: 0.3 },
            { name: 'Apfel', protein: 0.3, carbs: 13.8, fats: 0.2 },
            { name: 'H√§hnchenbrust', protein: 31, carbs: 0, fats: 3.6 },
            { name: 'Haferflocken', protein: 13.5, carbs: 60, fats: 7, barcode: '4008400401523' },
            { name: 'Griechischer Joghurt', protein: 10, carbs: 4, fats: 0.4 },
            { name: 'Reis (gekocht)', protein: 2.7, carbs: 28, fats: 0.3 },
            { name: 'Ei', protein: 12.6, carbs: 1.1, fats: 10.6 },
            { name: 'Lachs', protein: 20, carbs: 0, fats: 13 },
            { name: 'Brokkoli', protein: 2.8, carbs: 7, fats: 0.4 },
            { name: 'Mandeln', protein: 21, carbs: 22, fats: 49 }
        ];
        let barcodeDetector = null;
        let barcodeStream = null;
        let barcodeScanning = false;

        // Init
        function init() {
            const savedKey = localStorage.getItem('groq_api_key');
            if (savedKey) {
                apiKey = savedKey;
                document.getElementById('setupScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                loadAllData();
                addAIMessage('Hey! üí™ Ready to crush it? Ask me anything or let me build you a killer workout!');
            }
        }

        function saveApiKey() {
            const input = document.getElementById('apiKeyInput').value.trim();
            if (!input || !input.startsWith('gsk_')) {
                setSetupStatus('Ung√ºltiger API-Key. Muss mit gsk_ beginnen.', 'error');
                return;
            }
            apiKey = input;
            localStorage.setItem('groq_api_key', apiKey);
            setSetupStatus('API-Key gespeichert. App wird geladen...');
            init();
        }

        function clearApiKey() {
            localStorage.removeItem('groq_api_key');
            apiKey = '';
            document.getElementById('apiKeyInput').value = '';
            document.getElementById('setupScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            setSetupStatus('API-Key wurde zur√ºckgesetzt.');
        }

        window.saveApiKey = saveApiKey;
        window.clearApiKey = clearApiKey;

        function setSetupStatus(message, type = 'info') {
            const status = document.getElementById('setupStatus');
            if (!status) return;
            status.textContent = message;
            status.style.color = type === 'error' ? 'var(--red)' : 'var(--text-secondary)';
        }

        function loadAllData() {
            loadProfile();
            loadStats();
            loadMacros();
            loadConversationMemory();
            renderExercises();
            renderWorkout();
        }

        // Profile
        function loadProfile() {
            const saved = localStorage.getItem('userProfile');
            if (saved) {
                userProfile = JSON.parse(saved);
                document.getElementById('userLevel').value = userProfile.level;
                document.getElementById('userGoal').value = userProfile.goal;
                document.getElementById('trainingDays').value = userProfile.trainingDays;
            }
        }

        function saveProfile() {
            userProfile = {
                level: document.getElementById('userLevel').value,
                goal: document.getElementById('userGoal').value,
                trainingDays: parseInt(document.getElementById('trainingDays').value)
            };
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
        }

        // Stats
        function loadStats() {
            const saved = localStorage.getItem('calisthenicsStats');
            if (saved) {
                stats = JSON.parse(saved);
                updateStatsDisplay();
            }
        }

        function saveStats() {
            localStorage.setItem('calisthenicsStats', JSON.stringify(stats));
            updateStatsDisplay();
        }

        function updateStatsDisplay() {
            document.getElementById('totalWorkouts').textContent = stats.totalWorkouts;
            document.getElementById('totalExercises').textContent = stats.totalExercises;
            document.getElementById('streak').textContent = stats.streak;
        }

        // Macros
        function loadMacros() {
            const saved = localStorage.getItem('dailyMacros');
            if (saved) {
                const data = JSON.parse(saved);
                const today = new Date().toDateString();
                if (data.date === today) {
                    macros = data.macros;
                    updateMacroDisplay();
                }
            }
        }

        function updateMacros() {
            const protein = parseInt(document.getElementById('proteinInput').value) || 0;
            const carbs = parseInt(document.getElementById('carbsInput').value) || 0;
            const fats = parseInt(document.getElementById('fatsInput').value) || 0;
            
            const calories = (protein * 4) + (carbs * 4) + (fats * 9);
            document.getElementById('caloriesInput').value = calories;
        }

        function logMacros() {
            const protein = parseInt(document.getElementById('proteinInput').value) || 0;
            const carbs = parseInt(document.getElementById('carbsInput').value) || 0;
            const fats = parseInt(document.getElementById('fatsInput').value) || 0;

            addMacrosToTotals(protein, carbs, fats);

            persistMacros();
            
            document.getElementById('proteinInput').value = 0;
            document.getElementById('carbsInput').value = 0;
            document.getElementById('fatsInput').value = 0;
            document.getElementById('caloriesInput').value = 0;
        }

        function updateMacroDisplay() {
            document.getElementById('totalProtein').textContent = macros.protein + 'g';
            document.getElementById('totalCarbs').textContent = macros.carbs + 'g';
            const totalCals = (macros.protein * 4) + (macros.carbs * 4) + (macros.fats * 9);
            document.getElementById('totalCals').textContent = totalCals;
        }

        function addMacrosToTotals(protein, carbs, fats) {
            macros.protein += protein;
            macros.carbs += carbs;
            macros.fats += fats;
            updateMacroDisplay();
        }

        function persistMacros() {
            const data = {
                date: new Date().toDateString(),
                macros: macros
            };
            localStorage.setItem('dailyMacros', JSON.stringify(data));
        }

        function setFoodStatus(message, type = 'info') {
            const status = document.getElementById('foodStatus');
            status.textContent = message;
            status.style.color = type === 'error' ? 'var(--red)' : 'var(--text-secondary)';
        }

        function setBarcodeStatus(message, type = 'info') {
            const status = document.getElementById('barcodeStatus');
            status.textContent = message;
            status.style.color = type === 'error' ? 'var(--red)' : 'var(--text-secondary)';
        }

        function normalizeFoodName(name) {
            return name.trim().toLowerCase();
        }

        async function addFoodFromLookup() {
            const foodNameRaw = document.getElementById('foodInput').value;
            const amount = parseFloat(document.getElementById('foodAmountInput').value);
            if (!foodNameRaw || !amount || amount <= 0) {
                setFoodStatus('Bitte Lebensmittel und eine g√ºltige Grammzahl eingeben.', 'error');
                return;
            }

            const foodName = normalizeFoodName(foodNameRaw);
            const match = foodDatabase.find(item => normalizeFoodName(item.name) === foodName);
            setFoodStatus('Suche in der Lebensmitteldatenbank...');

            if (match) {
                const ratio = amount / 100;
                const protein = Math.round(match.protein * ratio * 10) / 10;
                const carbs = Math.round(match.carbs * ratio * 10) / 10;
                const fats = Math.round(match.fats * ratio * 10) / 10;
                addMacrosToTotals(protein, carbs, fats);
                persistMacros();
                setFoodStatus(`Hinzugef√ºgt: ${match.name} (${amount}g): P${protein} C${carbs} F${fats}.`);
                return;
            }

            setFoodStatus('Nicht gefunden ‚Äî KI sch√§tzt die Makros...');
            try {
                const estimate = await estimateFoodMacrosWithAI(foodNameRaw, amount);
                addMacrosToTotals(estimate.protein, estimate.carbs, estimate.fats);
                persistMacros();
                setFoodStatus(`KI-Sch√§tzung f√ºr ${foodNameRaw} (${amount}g): P${estimate.protein} C${estimate.carbs} F${estimate.fats}.`);
            } catch (error) {
                setFoodStatus(`KI-Sch√§tzung fehlgeschlagen: ${error.message}`, 'error');
            }
        }

        async function estimateFoodMacrosWithAI(foodName, amount) {
            if (!apiKey) {
                throw new Error('Kein API-Key gesetzt. Bitte Groq API-Key hinzuf√ºgen.');
            }

            const prompt = `Sch√§tze die Makros f√ºr ${amount}g von "${foodName}". ` +
                `Antworte NUR mit g√ºltigem JSON und den Schl√ºsseln protein, carbs, fats. ` +
                `Werte sind Grammzahlen und auf eine Dezimalstelle gerundet.`;

            const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'llama-3.3-70b-versatile',
                    messages: [
                        { role: 'system', content: 'Du bist Ern√§hrungsexperte und antwortest strikt mit JSON.' },
                        { role: 'user', content: prompt }
                    ],
                    temperature: 0.2,
                    max_tokens: 200
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error?.message || `HTTP ${response.status}`);
            }

            const data = await response.json();
            const content = data.choices[0].message.content.trim();
            const jsonMatch = content.match(/\{[\s\S]*\}/);
            if (!jsonMatch) {
                throw new Error('Kein JSON in der KI-Antwort gefunden.');
            }
            const parsed = JSON.parse(jsonMatch[0]);
            return {
                protein: Number(parsed.protein) || 0,
                carbs: Number(parsed.carbs) || 0,
                fats: Number(parsed.fats) || 0
            };
        }

        async function startBarcodeScanner() {
            if (!('BarcodeDetector' in window)) {
                setBarcodeStatus('Barcode-Scanner wird nicht unterst√ºtzt.', 'error');
                return;
            }
            if (!window.isSecureContext) {
                setBarcodeStatus('Barcode-Scan ben√∂tigt HTTPS oder localhost.', 'error');
                return;
            }
            if (barcodeScanning) {
                return;
            }

            barcodeDetector = new BarcodeDetector({
                formats: ['ean_13', 'ean_8', 'upc_a', 'upc_e', 'qr_code']
            });

            try {
                barcodeStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                const video = document.getElementById('barcodeVideo');
                video.srcObject = barcodeStream;
                video.classList.add('active');
                barcodeScanning = true;
                setBarcodeStatus('Scanner aktiv. Barcode vor die Kamera halten...');
                scanBarcodeFrame();
            } catch (error) {
                setBarcodeStatus(`Kamera konnte nicht gestartet werden: ${error.message}`, 'error');
            }
        }

        function stopBarcodeScanner() {
            barcodeScanning = false;
            const video = document.getElementById('barcodeVideo');
            video.classList.remove('active');
            if (barcodeStream) {
                barcodeStream.getTracks().forEach(track => track.stop());
                barcodeStream = null;
            }
            setBarcodeStatus('Scanner gestoppt.');
        }

        async function scanBarcodeFrame() {
            if (!barcodeScanning) {
                return;
            }
            try {
                const video = document.getElementById('barcodeVideo');
                const barcodes = await barcodeDetector.detect(video);
                if (barcodes.length > 0) {
                    const code = barcodes[0].rawValue;
                    document.getElementById('barcodeInput').value = code;
                    setBarcodeStatus(`Barcode erkannt: ${code}`);
                    stopBarcodeScanner();
                    lookupFoodByBarcode();
                    return;
                }
            } catch (error) {
                setBarcodeStatus(`Scan-Fehler: ${error.message}`, 'error');
                stopBarcodeScanner();
                return;
            }
            requestAnimationFrame(scanBarcodeFrame);
        }

        function lookupFoodByBarcode() {
            const barcode = document.getElementById('barcodeInput').value.trim();
            const amount = parseFloat(document.getElementById('foodAmountInput').value) || 100;
            if (!barcode) {
                setBarcodeStatus('Bitte Barcode eingeben oder scannen.', 'error');
                return;
            }
            const match = foodDatabase.find(item => item.barcode === barcode);
            if (!match) {
                setBarcodeStatus('Barcode nicht gefunden. Bitte Lebensmittel manuell eingeben.', 'error');
                return;
            }
            const ratio = amount / 100;
            const protein = Math.round(match.protein * ratio * 10) / 10;
            const carbs = Math.round(match.carbs * ratio * 10) / 10;
            const fats = Math.round(match.fats * ratio * 10) / 10;
            addMacrosToTotals(protein, carbs, fats);
            persistMacros();
            setBarcodeStatus(`Gefunden: ${match.name} (${amount}g): P${protein} C${carbs} F${fats}.`);
            setFoodStatus(`Hinzugef√ºgt per Barcode: ${match.name}.`);
        }

        // Conversation Memory
        function loadConversationMemory() {
            const saved = localStorage.getItem('conversationMemory');
            if (saved) {
                conversationMemory = JSON.parse(saved);
            }
        }

        function saveToMemory(userMsg, aiResponse) {
            conversationMemory.push({
                timestamp: Date.now(),
                user: userMsg,
                ai: aiResponse
            });
            
            if (conversationMemory.length > 20) {
                conversationMemory = conversationMemory.slice(-20);
            }
            
            localStorage.setItem('conversationMemory', JSON.stringify(conversationMemory));
        }

        // Exercises
        function renderExercises() {
            const list = document.getElementById('exerciseList');
            list.innerHTML = exercises.map(ex => `
                <div class="exercise-card" onclick="addToWorkout('${ex.name}')">
                    <div class="exercise-header">
                        <div>
                            <div class="exercise-name">${ex.name}</div>
                            <div class="exercise-meta mono">${ex.sets}</div>
                        </div>
                        <div class="exercise-level level-${ex.level}">${ex.level}</div>
                    </div>
                    <div class="exercise-meta">${ex.desc}</div>
                </div>
            `).join('');
        }

        function addToWorkout(exerciseName) {
            const exercise = exercises.find(ex => ex.name === exerciseName);
            if (exercise && !currentWorkout.find(ex => ex.name === exerciseName)) {
                currentWorkout.push(exercise);
                renderWorkout();
            }
        }

        function removeFromWorkout(exerciseName) {
            currentWorkout = currentWorkout.filter(ex => ex.name !== exerciseName);
            renderWorkout();
        }

        function clearWorkout() {
            if (currentWorkout.length > 0 && confirm('Clear workout?')) {
                currentWorkout = [];
                renderWorkout();
            }
        }

        function renderWorkout() {
            const builder = document.getElementById('workoutBuilder');
            if (currentWorkout.length === 0) {
                builder.innerHTML = '<div class="workout-slot">No exercises yet - add some or ask AI!</div>';
            } else {
                builder.innerHTML = currentWorkout.map(ex => `
                    <div class="workout-slot filled">
                        <div>
                            <div class="exercise-name">${ex.name}</div>
                            <div class="exercise-meta mono">${ex.sets}</div>
                        </div>
                        <button class="remove-btn" onclick="removeFromWorkout('${ex.name}')">‚úï</button>
                    </div>
                `).join('');
            }
        }

        function startWorkout() {
            if (currentWorkout.length === 0) {
                alert('Add exercises first!');
                return;
            }
            if (confirm(`Start workout with ${currentWorkout.length} exercises?`)) {
                stats.totalWorkouts++;
                stats.totalExercises += currentWorkout.length;
                stats.streak++;
                saveStats();
                startTimer();
                alert('Workout started! Let\'s go! üí™');
            }
        }

        // Timer
        function startTimer() {
            if (!isTimerRunning) {
                isTimerRunning = true;
                timerInterval = setInterval(() => {
                    timerSeconds++;
                    updateTimerDisplay();
                }, 1000);
            }
        }

        function pauseTimer() {
            isTimerRunning = false;
            clearInterval(timerInterval);
        }

        function resetTimer() {
            pauseTimer();
            timerSeconds = 0;
            updateTimerDisplay();
        }

        function updateTimerDisplay() {
            const mins = Math.floor(timerSeconds / 60);
            const secs = timerSeconds % 60;
            document.getElementById('timerDisplay').textContent = 
                `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        // Chat
        function addUserMessage(text) {
            const container = document.getElementById('chatContainer');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message user-message';
            msgDiv.textContent = text;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        function addAIMessage(text) {
            const container = document.getElementById('chatContainer');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message ai-message';
            msgDiv.textContent = text;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
            return msgDiv;
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            input.value = '';
            addUserMessage(message);
            
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span class="loading"></span>';

            const thinkingMsg = addAIMessage('Thinking...');

            try {
                const response = await callGroqAPI(message);
                thinkingMsg.remove();
                addAIMessage(response);
                
                saveToMemory(message, response);
                
                if (message.toLowerCase().includes('plan') || message.toLowerCase().includes('workout')) {
                    parseWorkoutFromResponse(response);
                }
                
                if (response.toLowerCase().includes('new exercise:')) {
                    parseNewExerciseFromResponse(response);
                }
            } catch (error) {
                thinkingMsg.remove();
                addAIMessage('‚ùå Error: ' + error.message);
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = '‚Üí';
            }
        }

        async function callGroqAPI(userMessage) {
            const memoryContext = conversationMemory.slice(-5).map(m => 
                `User: ${m.user}\nAI: ${m.ai}`
            ).join('\n\n');

            const systemPrompt = `You are an expert calisthenics coach. Speak like Gen Z (casual, direct, honest) but stay precise on content.

MEMORY - Previous conversations:
${memoryContext}

User Profile:
- Level: ${userProfile.level}
- Goal: ${userProfile.goal}
- Training days/week: ${userProfile.trainingDays}
- Current workout: ${currentWorkout.map(ex => ex.name).join(', ') || 'Empty'}
- Total workouts: ${stats.totalWorkouts}
- Today's macros: ${macros.protein}g protein, ${macros.carbs}g carbs, ${macros.fats}g fats

Available exercises: ${exercises.map(ex => ex.name).join(', ')}

CAPABILITIES:
1. Create workout plans using existing exercises
2. Create NEW custom exercises when needed
3. Give macro/nutrition advice
4. Track progress and give feedback

When creating workout plans, format:
WORKOUT PLAN:
- Exercise 1
- Exercise 2
- Exercise 3

When creating NEW exercises, format:
NEW EXERCISE: [name]
LEVEL: [beginner/intermediate/advanced]
DESC: [description]
SETS: [e.g., 3x10]

Be concise, actionable, honest. Remember past conversations and user's progress.`;

            const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'llama-3.3-70b-versatile',
                    messages: [
                        { role: 'system', content: systemPrompt },
                        ...chatHistory.slice(-4),
                        { role: 'user', content: userMessage }
                    ],
                    temperature: 0.7,
                    max_tokens: 800
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error?.message || `HTTP ${response.status}`);
            }

            const data = await response.json();
            const aiResponse = data.choices[0].message.content;
            
            chatHistory.push({ role: 'user', content: userMessage });
            chatHistory.push({ role: 'assistant', content: aiResponse });

            return aiResponse;
        }

        function parseWorkoutFromResponse(response) {
            const lines = response.split('\n');
            let inWorkoutSection = false;
            const workoutExercises = [];

            for (const line of lines) {
                if (line.includes('WORKOUT PLAN:')) {
                    inWorkoutSection = true;
                    continue;
                }
                
                if (inWorkoutSection && line.trim().startsWith('-')) {
                    const exerciseName = line.replace('-', '').trim();
                    const exercise = exercises.find(ex => 
                        ex.name.toLowerCase().includes(exerciseName.toLowerCase())
                    );
                    if (exercise && !workoutExercises.find(e => e.name === exercise.name)) {
                        workoutExercises.push(exercise);
                    }
                }
            }

            if (workoutExercises.length > 0) {
                currentWorkout = workoutExercises;
                renderWorkout();
                switchTab('workout');
                setTimeout(() => addAIMessage('‚úÖ Added exercises to your workout!'), 500);
            }
        }

        function parseNewExerciseFromResponse(response) {
            const lines = response.split('\n');
            let newExercise = {};
            
            for (const line of lines) {
                if (line.startsWith('NEW EXERCISE:')) {
                    newExercise.name = line.replace('NEW EXERCISE:', '').trim();
                }
                if (line.startsWith('LEVEL:')) {
                    newExercise.level = line.replace('LEVEL:', '').trim().toLowerCase();
                }
                if (line.startsWith('DESC:')) {
                    newExercise.desc = line.replace('DESC:', '').trim();
                }
                if (line.startsWith('SETS:')) {
                    newExercise.sets = line.replace('SETS:', '').trim();
                }
            }

            if (newExercise.name && newExercise.level && newExercise.desc && newExercise.sets) {
                newExercise.gif = '';
                exercises.push(newExercise);
                localStorage.setItem('customExercises', JSON.stringify(exercises));
                renderExercises();
                addAIMessage(`‚úÖ Created new exercise: ${newExercise.name}!`);
            }
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
        }

        // Init on load
        init();

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(reg => console.log('‚úÖ PWA Service Worker registered'))
                    .catch(err => console.log('‚ùå SW registration failed:', err));
            });
        }

        // Install prompt for iOS
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
        });
    </script>
</body>
</html>
